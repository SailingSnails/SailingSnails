<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>검색</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    @font-face {
      font-family: 'Freesentation';
      src: url('./Freesentation-3Light.ttf') format('truetype');
      font-weight: 300;
    }
    @font-face {
      font-family: 'Freesentation';
      src: url('./Freesentation-6SemiBold.ttf') format('truetype');
      font-weight: 600;
    }
    body {
      font-family: 'Freesentation', 'Malgun Gothic', Arial, sans-serif;
      font-weight: 300;
      color: #222;
      font-size: 1em;
      background: #F1F4F8;
    }
    .controls { 
      display: flex; 
      gap: 12px; 
      align-items: center;
      margin-top: 24px;
      margin-bottom: 40px; }
    .controls input, .controls select {
      background: #fff;
      color: #222;
      border: 2px solid #222;
      border-radius: 5px;
      padding: 8px 8px;
      font-size: 1.1em;
    }
    .controls input {
      width: 320px;
      margin-left: 12px;
    }
    .count-box {
      margin: 24px 0 18px 0;
      font-size: 1.5em;
      font-weight: 600;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: #fff;
      font-size: 0.9em;
    }
    td {
      border: 1px solid #e0e0e0;
      padding: 8px 6px;
      text-align: center;
    }
    th {
      background: #2c3e50;
      padding: 8px 6px;
      color: #fff;
    }
    .col-캐슷 {
      text-align: left !important;
    }
    .fa-link {
      color: #2196f3;
      font-size: 1em;
    }
    .icon-link {
      display: inline-block;
      padding: 0px 2px;
    }
    .highlight {
      background: #ffe066;
      color: #222;
      font-weight: 600;
    }
    .selected-row {
      background: #fef3c7 !important;
      color: #333 !important;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="controls">
    <input type="text" id="search" placeholder="검색어 입력">
    <select id="selected_col">
      <option value="">전체</option>
      <option value="날짜">날짜</option>
      <option value="시간">시간</option>
      <option value="제작사">제작사</option>
      <option value="시즌">시즌</option>
      <option value="장르">장르</option>
      <option value="극">극</option>
      <option value="자n">자n</option>
      <option value="캐슷">캐슷</option>
      <option value="극장">극장</option>
    </select>
  </div>
  <div id="count-box" class="count-box"></div>
  <table id="data-table">
    <thead>
      <tr>
        <th>날짜</th>
        <th>시간</th>
        <th>제작사</th>
        <th>시즌</th>
        <th>장르</th>
        <th>극</th>
        <th>자n</th>
        <th class="col-캐슷">캐슷</th>
        <th>극장</th>
        <th>캐보</th>
        <th>후기</th>
        <th>L1</th>
        <th>L2</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    const colNames = ['날짜','시간','제작사','시즌','장르','극','자n','캐슷','극장','캐보','후기','L1','L2'];
    const buttonCols = ['캐보','후기','L1','L2'];
    let data = [];

    function excelDateToStr(excelDate) {
      if (typeof excelDate === 'number') {
        const date = new Date(Date.UTC(1899, 11, 30) + excelDate * 86400000);
        return date.toISOString().slice(0,10);
      }
      return excelDate;
    }
    function excelTimeToStr(excelTime) {
      if (typeof excelTime === 'number') {
        let totalMinutes = Math.round(excelTime * 24 * 60);
        let hours = Math.floor(totalMinutes / 60);
        let minutes = totalMinutes % 60;
        return (hours<10?'0':'')+hours+':'+(minutes<10?'0':'')+minutes;
      } else if (typeof excelTime === 'string' && excelTime.match(/^\d{1,2}:\d{2}/)) {
        return excelTime.slice(0,5);
      }
      return excelTime;
    }
    function formatCastDisplay(str) {
      return str.trim().replace(/ /g, ', ').replace(/_/g, ' ');
    }
    function highlightText(text, keyword) {
      if (!keyword) return text;
      const re = new RegExp(keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
      return text.replace(re, match => `<span class="highlight">${match}</span>`);
    }

    window.onload = function() {
      fetch('RawData.xlsx')
        .then(res => res.arrayBuffer())
        .then(dataArr => {
          const wb = XLSX.read(dataArr, {type: 'array'});
          const sheet = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1, defval:""});
          const header = sheet[0];
          const rows = sheet.slice(1);
          const showIdx = colNames.map(cn => header.indexOf(cn));
          data = rows.map(row => showIdx.map(idx => row[idx]));
          const tIdx = colNames.indexOf('시간'), dIdx = colNames.indexOf('날짜');
          data.forEach(r => {
            r[dIdx] = excelDateToStr(r[dIdx]);
            r[tIdx] = excelTimeToStr(r[tIdx]);
          });
          filterData();
        })
        .catch(err => {
          alert('RawData.xlsx 파일을 불러올 수 없습니다.');
          console.error(err);
        });
    };

    function renderTable(filtered) {
      const search = document.getElementById('search').value.trim();
      const tbody = document.querySelector('#data-table tbody');
      tbody.innerHTML = '';
      filtered.forEach((row, rowIdx) => {
        const tr = document.createElement('tr');
        row.forEach((cell, idx) => {
          const col = colNames[idx];
          const td = document.createElement('td');
          if (col === '캐슷') td.className = 'col-캐슷';
          if (buttonCols.includes(col)) {
            const url = (cell || '').trim();
            if (url && url !== '-') {
              const a = document.createElement('a');
              a.href = url;
              a.target = '_blank';
              a.className = 'icon-link';
              a.innerHTML = '<i class="fa-solid fa-link"></i>';
              td.appendChild(a);
            }
          } else if (col === '캐슷') {
            let disp = cell ? formatCastDisplay(String(cell)) : '';
            td.innerHTML = highlightText(disp, search);
          } else {
            td.innerHTML = highlightText(String(cell ?? ''), search);
          }
          td.addEventListener('click', function() {
            tbody.querySelectorAll('tr').forEach(tr2 => tr2.classList.remove('selected-row'));
            tr.classList.add('selected-row');
          });
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function renderCount(filtered) {
      const 본_횟수 = filtered.length;
      const 극Idx = colNames.indexOf('극');
      const 극_개수 = new Set(filtered.map(r => r[극Idx])).size;
      document.getElementById('count-box').innerHTML = `&nbsp;&nbsp;▶ ${극_개수} 극 &nbsp; & &nbsp; ${본_횟수} 회`;
    }

    function filterData() {
      const search = document.getElementById('search').value.trim();
      const selected_col = document.getElementById('selected_col').value;
      let filtered = data;
      if (search) {
        if (!selected_col) {
          const searchIdx = colNames
            .map((name, idx) => buttonCols.includes(name) ? null : idx)
            .filter(idx => idx !== null);
          filtered = data.filter(row =>
            searchIdx.some(idx => String(row[idx] || '').toLowerCase().includes(search.toLowerCase()))
          );
        } else if (selected_col === '캐슷') {
          const idx = colNames.indexOf('캐슷');
          filtered = data.filter(row => (' ' + row[idx] + ' ').toLowerCase().includes(' ' + search.toLowerCase() + ' '));
        } else if (selected_col === '제작사') {
          const idx = colNames.indexOf('제작사');
          filtered = data.filter(row => {
            const makers = ('┃'+row[idx].replace(/, /g,'┃')+'┃').toLowerCase();
            return makers.includes('┃'+search.toLowerCase()+'┃');
          });
        } else if (['극','극장'].includes(selected_col)) {
          const idx = colNames.indexOf(selected_col);
          filtered = data.filter(row => String(row[idx]) === search);
        } else if (buttonCols.includes(selected_col)) {
          const idx = colNames.indexOf(selected_col);
          filtered = data.filter(row => ((row[idx] || '').trim()).toLowerCase().includes(search.toLowerCase()));
        } else {
          const idx = colNames.indexOf(selected_col);
          filtered = data.filter(row => String(row[idx]).toLowerCase().includes(search.toLowerCase()));
        }
      }
      renderCount(filtered);
      renderTable(filtered);
    }

    document.getElementById('search').addEventListener('input', filterData);
    document.getElementById('selected_col').addEventListener('change', filterData);
    document.getElementById('search').addEventListener('keydown', e => { if(e.key==='Enter') filterData(); });
  </script>
</body>
</html>